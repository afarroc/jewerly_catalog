{% extends 'home/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>{{ title }}</h2>
                <a href="{% url 'products:image_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver a Im√°genes
                </a>
            </div>

            <!-- Diagnostic Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Resumen de Diagn√≥stico</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Timestamp:</strong><br>
                            {{ diagnostic_info.timestamp|date:"d/m/Y H:i:s" }}
                        </div>
                        <div class="col-md-3">
                            <strong>Usuario:</strong><br>
                            {{ diagnostic_info.user }}
                        </div>
                        <div class="col-md-3">
                            <strong>Storage Type:</strong><br>
                            {{ diagnostic_info.storage_type }}
                        </div>
                        <div class="col-md-3">
                            <strong>Bucket:</strong><br>
                            {{ diagnostic_info.bucket_name }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Results -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Resultados de Pruebas</h5>
                </div>
                <div class="card-body">
                    {% for test in diagnostic_info.tests %}
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <h6 class="mb-0 me-3">{{ test.name }}</h6>
                                {% if test.status == 'success' %}
                                    <span class="badge bg-success">‚úì √âxito</span>
                                {% elif test.status == 'warning' %}
                                    <span class="badge bg-warning">‚ö†Ô∏è Advertencia</span>
                                {% else %}
                                    <span class="badge bg-danger">‚úó Error</span>
                                {% endif %}
                            </div>
                            <div class="ms-3">
                                {% for key, value in test.details.items %}
                                    <div class="row">
                                        <div class="col-md-4"><strong>{{ key|title }}:</strong></div>
                                        <div class="col-md-8">
                                            {% if value|length > 50 %}
                                                <code style="word-break: break-all;">{{ value }}</code>
                                            {% else %}
                                                <code>{{ value }}</code>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% if not forloop.last %}
                            <hr>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Folder Structure -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Estructura de Carpetas</h5>
                </div>
                <div class="card-body">
                    {% if diagnostic_info.folders.error %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Error al verificar carpetas: {{ diagnostic_info.folders.error }}
                        </div>
                    {% else %}
                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h4 class="text-primary">{{ diagnostic_info.folders.count }}</h4>
                                    <small class="text-muted">Carpetas encontradas</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h4 class="text-success">{{ diagnostic_info.folders.total_objects }}</h4>
                                    <small class="text-muted">Archivos totales</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="alert alert-info py-2">
                                        <small><strong>Nota:</strong> Las carpetas se crean autom√°ticamente</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if diagnostic_info.folders.list %}
                            <div class="mt-3">
                                <h6>Carpetas detectadas:</h6>
                                <div class="row">
                                    {% for folder in diagnostic_info.folders.list %}
                                        <div class="col-md-6 mb-2">
                                            <code class="d-block p-2 bg-light rounded">
                                                üìÅ {{ folder }}/
                                            </code>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Recent Uploads -->
            {% if diagnostic_info.recent_uploads %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Subidas Recientes (√∫ltimas 24 horas)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>T√≠tulo</th>
                                        <th>Archivo</th>
                                        <th>Tama√±o</th>
                                        <th>Fecha</th>
                                        <th>URL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for upload in diagnostic_info.recent_uploads %}
                                        <tr>
                                            <td>{{ upload.id }}</td>
                                            <td>{{ upload.title }}</td>
                                            <td><code style="font-size: 0.8em;">{{ upload.filename }}</code></td>
                                            <td>{{ upload.size|filesizeformat }}</td>
                                            <td>{{ upload.uploaded_at|date:"d/m/Y H:i" }}</td>
                                            <td>
                                                {% if upload.url != 'No URL' %}
                                                    <a href="{{ upload.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-external-link-alt"></i> Ver
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted">No disponible</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Acciones de Diagn√≥stico</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <a href="{% url 'products:s3_diagnostic' %}" class="btn btn-primary w-100">
                                <i class="fas fa-sync-alt"></i> Ejecutar Diagn√≥stico Nuevamente
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="{% url 'products:image_upload' %}" class="btn btn-success w-100">
                                <i class="fas fa-upload"></i> Probar Subida de Imagen
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Troubleshooting Tips -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Consejos de Soluci√≥n de Problemas</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb"></i> Si hay errores de S3:</h6>
                        <ul class="mb-0">
                            <li>Verifique que las variables de entorno <code>AWS_ACCESS_KEY_ID</code> y <code>AWS_SECRET_ACCESS_KEY</code> est√©n configuradas en Render</li>
                            <li>Aseg√∫rese de que el usuario IAM tenga permisos para el bucket <code>management360</code></li>
                            <li>Verifique que la regi√≥n del bucket sea <code>us-east-2</code></li>
                            <li>Confirme que la pol√≠tica del bucket permita las operaciones necesarias</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.badge {
    font-size: 0.75em;
}

.table code {
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 0.85em;
}

.alert-info {
    border-color: #0dcaf0;
    background-color: rgba(13, 202, 240, 0.1);
}
</style>
{% endblock %}